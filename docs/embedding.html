<!doctype html>
<html class="no-js" lang="en-us" prefix="og: http://ogp.me/ns#">

<head>
    <meta charset="utf-8">
    <title>Embedding Guide | tweakflow - safe embeddable scripting language for the JVM</title>

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="description" content="" />

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif|Lato|Roboto|Inconsolata">
    <link rel="stylesheet" href="./fontawesome/css/all.min.css">
    <link rel="stylesheet" href="./css/normalize.css">
    <link rel="stylesheet" href="./css/layout.css">
    <link rel="stylesheet" href="./css/style.css">

    <link rel="stylesheet" href="./js/highlight-tweakflow/tweakflow-light.css">

    <script type="text/javascript" src="./js/ie-shim.js"></script>
    <script type="text/javascript" src="./js/es6-shim.js"></script>
    <script type="text/javascript" src="./js/highlight/highlight.min.js"></script>
    <script type="text/javascript" src="./js/highlight-tweakflow/tweakflow.js"></script>
    <script type="text/javascript">
      hljs.registerLanguage('tweakflow', window.hljsDefineTweakflow);
      hljs.configure({languages: ["xml", "tweakflow", "plaintext", "java", "text"]});
      hljs.initHighlightingOnLoad();
    </script>

    <link rel="apple-touch-icon" sizes="180x180" href="./img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./img/favicon-16x16.png">
    <link rel="manifest" href="./img/manifest.json">
    <link rel="mask-icon" href="./img/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="./img/favicon.ico">
    <meta name="msapplication-config" content="/img/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">

    <meta name="apple-mobile-web-app-title" content="tweakflow - safe embeddable scripting language for the JVM">
    <meta name="application-name" content="tweakflow - safe embeddable scripting language for the JVM">
    <meta name="generator" content="Hugo 0.111.1">

</head>


<body>
    <header>
  <div class="menu-narrow">
    <div class="dropdown">
      <div class="dropdown-trigger">
        <nav role="navigation" class="menu__items-wrapper-left">
        <ul class="menu__items">
          <li class="menu__item">
            <a class="menu__item-version-link"><i class="caret fas fa-fw fa-caret-right"></i><b>Tweakflow</b> v1.4.4</a>
          </li>
        </ul>
        </nav>
      </div>
      <div class="dropdown-menu" id="dropdown-menu-narrow" role="menu">
        <div class="dropdown-content">
          <a href="./index.html" class="dropdown-item">
            Home
          </a>
          
          
          
          <a class="dropdown-item" href="./getting-started.html">Getting started</a>
          
          <a class="dropdown-item" href="./tools.html">Tools</a>
          
          <a class="dropdown-item" href="./embedding.html">Embedding</a>
          
          <a class="dropdown-item" href="./reference.html">Reference</a>
          
          <a class="dropdown-item" href="./support.html">Support</a>
          
          
          <hr class="dropdown-divider" />
          
          
          
          <a class="dropdown-item" href="./modules/std.html">std</a>
          
          <a class="dropdown-item" href="./modules/std/spec.html">std/spec</a>
          
          <a class="dropdown-item" href="https://github.com/twineworks/tweakflow/">GitHub</a>
          
          <a class="dropdown-item" href="https://gitter.im/twineworks/tweakflow">Discuss</a>
          
          
        </div>
      </div>
    </div>
  </div>
  <div class="menu">
    
    
    
    <nav role="navigation" class="menu__items-wrapper-left">
      <ul class="menu__items">
        <li class="menu__item">
          <a class="menu__item-version-link" href="./index.html"
            ><b>Tweakflow</b> v1.4.4</a
          >
        </li>
        
        
        
        <li class="menu__item">
          <a class="menu__item-link" href="./getting-started.html">Getting started</a>
        </li>
        
        <li class="menu__item">
          <a class="menu__item-link" href="./tools.html">Tools</a>
        </li>
        
        <li class="menu__item active">
          <a class="menu__item-link" href="./embedding.html">Embedding</a>
        </li>
        
        <li class="menu__item">
          <a class="menu__item-link" href="./reference.html">Reference</a>
        </li>
        
        <li class="menu__item">
          <a class="menu__item-link" href="./support.html">Support</a>
        </li>
        
        
      </ul>
    </nav>
    <nav role="navigation" class="menu__items-wrapper-right">
      <ul class="menu__items">
        
        
        
        <li class="menu__item">
          <a class="menu__item-link" href="./modules/std.html">std</a>
        </li>
        
        <li class="menu__item">
          <a class="menu__item-link" href="./modules/std/spec.html">std/spec</a>
        </li>
        
        <li class="menu__item">
          <a class="menu__item-link" href="https://github.com/twineworks/tweakflow/">GitHub</a>
        </li>
        
        <li class="menu__item">
          <a class="menu__item-link" href="https://gitter.im/twineworks/tweakflow">Discuss</a>
        </li>
        
        
      </ul>
    </nav>
  </div>
</header>
<script type="text/javascript" src="./js/dropdown.js"></script>

    <div class="content-wrapper">
      
      <aside class="toc">
        <div class="toc-wrapper">
          <div class="scrollable-parent">
            <div class="scrollable-content">
              <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#requirements">Requirements</a></li>
        <li><a href="#getting-tweakflow">Getting tweakflow</a></li>
        <li><a href="#tweakflow-values">Tweakflow values</a>
          <ul>
            <li><a href="#creating-values">Creating values</a></li>
            <li><a href="#inspecting-values">Inspecting values</a></li>
          </ul>
        </li>
        <li><a href="#evaluating-expressions">Evaluating expressions</a>
          <ul>
            <li><a href="#examples">Examples</a></li>
          </ul>
        </li>
        <li><a href="#evaluating-a-set-of-variables">Evaluating a set of variables</a>
          <ul>
            <li><a href="#examples-1">Examples</a></li>
          </ul>
        </li>
        <li><a href="#evaluating-modules">Evaluating modules</a>
          <ul>
            <li><a href="#examples-2">Examples</a></li>
          </ul>
        </li>
        <li><a href="#calling-user-functions">Calling user functions</a>
          <ul>
            <li><a href="#examples-3">Examples</a></li>
          </ul>
        </li>
        <li><a href="#error-handling">Error handling</a>
          <ul>
            <li><a href="#examples-4">Examples</a></li>
          </ul>
        </li>
        <li><a href="#limiting-evaluation-time">Limiting evaluation time</a></li>
      </ul>
    </li>
  </ul>
</nav>
            </div>
          </div>
        </div>
      </aside>
      
      <main class="single-content " role="main">
        <h2 id="requirements">Requirements</h2>
<p>Tweakflow requires Java 8 or later. Builds are tested against JDK 8, 11 and 13.</p>
<h2 id="getting-tweakflow">Getting tweakflow</h2>
<p>You can get the tweakflow jar from the <a href="https://github.com/twineworks/tweakflow/releases">releases page</a> or from maven central:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>com.twineworks<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>tweakflow<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;version&gt;</span>1.4.4<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><h2 id="tweakflow-values">Tweakflow values</h2>
<p>Whenever the application is exchanging data with tweakflow code, it does so through immutable value objects of class <a href="https://github.com/twineworks/tweakflow/blob/master/src/main/java/com/twineworks/tweakflow/lang/values/Value.java">Value</a>. Variable values, function parameters, function return values, everything is a value in tweakflow.</p>
<h3 id="creating-values">Creating values</h3>
<p>The <a href="https://github.com/twineworks/tweakflow/blob/master/src/main/java/com/twineworks/tweakflow/lang/values/Values.java">Values</a> class provides static singleton members for certain constants and factory methods for creating values of all types.</p>
<p>The <code>nil</code> value is represented by the static singleton value <code>Values.NIL</code>. Boolean <code>true</code> and <code>false</code> are represented by singletons <code>Values.TRUE</code> and <code>Values.FALSE</code>.</p>
<p>For all other cases Values provides the overloaded static factory method <code>make</code>.</p>
<p>Creating strings, longs, and doubles is straightforward. Just pass a String, long or double to the overloaded <code>Values.make</code> factory method.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Value a <span style="color:#f92672">=</span> Values<span style="color:#f92672">.</span><span style="color:#a6e22e">make</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;foo&#34;</span><span style="color:#f92672">);</span>  <span style="color:#75715e">// a string
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>Value b <span style="color:#f92672">=</span> Values<span style="color:#f92672">.</span><span style="color:#a6e22e">make</span><span style="color:#f92672">(</span><span style="color:#ae81ff">1</span><span style="color:#f92672">);</span>      <span style="color:#75715e">// a long
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>Value c <span style="color:#f92672">=</span> Values<span style="color:#f92672">.</span><span style="color:#a6e22e">make</span><span style="color:#f92672">(</span><span style="color:#ae81ff">1.2d</span><span style="color:#f92672">);</span>   <span style="color:#75715e">// a double
</span></span></span></code></pre></div><p>To create a datetime, first create a <a href="https://github.com/twineworks/tweakflow/blob/master/src/main/java/com/twineworks/tweakflow/lang/values/DateTimeValue.java">DateTimeValue</a> using one of its constructors, and pass that to <code>Values.make</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Value now <span style="color:#f92672">=</span> Values<span style="color:#f92672">.</span><span style="color:#a6e22e">make</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">new</span> DateTimeValue<span style="color:#f92672">(</span>ZonedDateTime<span style="color:#f92672">.</span><span style="color:#a6e22e">now</span><span style="color:#f92672">()));</span> <span style="color:#75715e">// a datetime
</span></span></span></code></pre></div><p>To create a dict, first create a <a href="https://github.com/twineworks/tweakflow/blob/master/src/main/java/com/twineworks/tweakflow/lang/values/DictValue.java">DictValue</a>, which is a persistent data structure mapping string keys to value objects. Remember that DictValue objects are immutable and all manipulation methods yield a new object. Pass a DictValue to <code>Values.make</code>, to create a tweakflow dict.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Value dict <span style="color:#f92672">=</span> Values<span style="color:#f92672">.</span><span style="color:#a6e22e">make</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> DictValue<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;foo&#34;</span><span style="color:#f92672">,</span> Values<span style="color:#f92672">.</span><span style="color:#a6e22e">make</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hello&#34;</span><span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;bar&#34;</span><span style="color:#f92672">,</span> Values<span style="color:#f92672">.</span><span style="color:#a6e22e">make</span><span style="color:#f92672">(</span><span style="color:#ae81ff">42L</span><span style="color:#f92672">)));</span>
</span></span></code></pre></div><p>To create a list, first create a <a href="https://github.com/twineworks/tweakflow/blob/master/src/main/java/com/twineworks/tweakflow/lang/values/ListValue.java">ListValue</a>, which is a persistent data structure. Remember that ListValue objects are immutable and all manipulation methods yield a new object. Pass a ListValue to <code>Values.make</code>, to create a tweakflow list.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Values list <span style="color:#f92672">=</span> Values<span style="color:#f92672">.</span><span style="color:#a6e22e">make</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ListValue<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>Values<span style="color:#f92672">.</span><span style="color:#a6e22e">make</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hello&#34;</span><span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>Values<span style="color:#f92672">.</span><span style="color:#a6e22e">make</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;world&#34;</span><span style="color:#f92672">)));</span>
</span></span></code></pre></div><p>To create a function, first create a <a href="https://github.com/twineworks/tweakflow/blob/master/src/main/java/com/twineworks/tweakflow/lang/values/UserFunctionValue.java">UserFunctionValue</a> which in turn consists of a <a href="https://github.com/twineworks/tweakflow/blob/master/src/main/java/com/twineworks/tweakflow/lang/values/FunctionSignature.java">FunctionSignature</a> and an implementation object implementing the  <a href="https://github.com/twineworks/tweakflow/blob/master/src/main/java/com/twineworks/tweakflow/lang/values/UserFunction.java">UserFunction</a> tag interface as well as the arity interface matching the function&rsquo;s parameter count. See <a href="./reference.html#functions-in-java">Functions in Java</a> for details, and the implementation of the standard library function <a href="./modules/std.html#regex-matching">regex.matching</a> for an <a href="https://github.com/twineworks/tweakflow/blob/master/src/main/java/com/twineworks/tweakflow/std/Regex.java#L62">example</a>, which returns a function to the caller.</p>
<p>The following snippet creates a function that takes one string parameter named <code>x</code> with default value <code>&quot;hello&quot;</code>, and returns a boolean.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Values<span style="color:#f92672">.</span><span style="color:#a6e22e">make</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> UserFunctionValue<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">new</span> FunctionSignature<span style="color:#f92672">(</span>Collections<span style="color:#f92672">.</span><span style="color:#a6e22e">singletonList</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> FunctionParameter<span style="color:#f92672">(</span><span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;x&#34;</span><span style="color:#f92672">,</span> Types<span style="color:#f92672">.</span><span style="color:#a6e22e">STRING</span><span style="color:#f92672">,</span> Values<span style="color:#f92672">.</span><span style="color:#a6e22e">make</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hello&#34;</span><span style="color:#f92672">))),</span>
</span></span><span style="display:flex;"><span>            Types<span style="color:#f92672">.</span><span style="color:#a6e22e">BOOLEAN</span><span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">new</span> MyAwesomeImplementation<span style="color:#f92672">()));</span> <span style="color:#75715e">// implements UserFunction and Arity1UserFunction
</span></span></span></code></pre></div><h3 id="inspecting-values">Inspecting values</h3>
<p>A <a href="https://github.com/twineworks/tweakflow/blob/master/src/main/java/com/twineworks/tweakflow/lang/values/Value.java">Value</a> object reports its <code>type</code>, which is one of the singleton objects on <a href="https://github.com/twineworks/tweakflow/blob/master/src/main/java/com/twineworks/tweakflow/lang/types/Types.java">Types</a>. It also has boolean <code>is{TypeName}</code> methods to determine the type.</p>
<p>Depending on the type of the value, call the method named after the type to retrieve the contained payload object. Strings are retrieved using <code>string</code>, lists are retrieved using <code>list</code>, and so on. Longs and doubles are retrieved using <code>longNum</code> and <code>doubleNum</code> respectively. Method names <code>long</code> and <code>double</code> are not allowed in Java.</p>
<p>It is an error to call the wrong payload function for the type of the value. Calling <code>string</code> for a value of type <code>long</code> will result in a runtime exception.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Value v <span style="color:#f92672">=</span> obtainSomeValue<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>v<span style="color:#f92672">.</span><span style="color:#a6e22e">isList</span><span style="color:#f92672">()){</span>
</span></span><span style="display:flex;"><span>  ListValue listValue <span style="color:#f92672">=</span> v<span style="color:#f92672">.</span><span style="color:#a6e22e">list</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// process...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>v<span style="color:#f92672">.</span><span style="color:#a6e22e">isDict</span><span style="color:#f92672">()){</span>
</span></span><span style="display:flex;"><span>  DictValue dictValue <span style="color:#f92672">=</span> v<span style="color:#f92672">.</span><span style="color:#a6e22e">dict</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// process...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> AssertionError<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;I need a list or a dict&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>To get the literal notation of a tweakflow value, use <a href="https://github.com/twineworks/tweakflow/blob/master/src/main/java/com/twineworks/tweakflow/lang/values/ValueInspector.java">ValueInspector.inspect</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>String dump <span style="color:#f92672">=</span> ValueInspector<span style="color:#f92672">.</span><span style="color:#a6e22e">inspect</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>    Values<span style="color:#f92672">.</span><span style="color:#a6e22e">make</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ListValue<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>Values<span style="color:#f92672">.</span><span style="color:#a6e22e">make</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hello&#34;</span><span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>Values<span style="color:#f92672">.</span><span style="color:#a6e22e">make</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;world&#34;</span><span style="color:#f92672">)))</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>dump<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// outputs: [&#34;hello&#34;, &#34;world&#34;]
</span></span></span></code></pre></div><h2 id="evaluating-expressions">Evaluating expressions</h2>
<p>The simplest case of embedding tweakflow is to evaluate independent, self-contained expressions in an empty scope. This is just a call to <a href="https://github.com/twineworks/tweakflow/blob/master/src/main/java/com/twineworks/tweakflow/lang/TweakFlow.java">TweakFlow</a>.evaluate.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>TweakFlow<span style="color:#f92672">.</span><span style="color:#a6e22e">evaluate</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;1+2&#34;</span><span style="color:#f92672">);</span> <span style="color:#75715e">// returns 3
</span></span></span></code></pre></div><p>The scope is empty, which means there is no access to any modules including the standard library. The expression must be entirely self-contained.</p>
<p>To give the expression some context, but not go all the way to maintaining a complete runtime, an application might embed a user expression into a let construct that defines some variables.</p>
<p>The following snippet puts variables <code>first_name</code> and <code>last_name</code> into scope. The expression is supposed to evaluate to a greeting line.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// exp stands in for a user-supplied expression
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>String exp <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;if (first_name &amp;&amp; last_name) then \n&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#39;Dear &#39; .. first_name .. &#39; &#39;.. last_name\n&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;else\n&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#39;Dear customer&#39;&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// make sure exp parses as an expression first
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>ParseResult parseResult <span style="color:#f92672">=</span> TweakFlow<span style="color:#f92672">.</span><span style="color:#a6e22e">parse</span><span style="color:#f92672">(</span>exp<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>parseResult<span style="color:#f92672">.</span><span style="color:#a6e22e">isSuccess</span><span style="color:#f92672">()){</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  String firstName <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Mary&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>  String lastName <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Poppins&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// construct the full expression to evaluate
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  String code <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;let {&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;  first_name: \&#34;&#34;</span><span style="color:#f92672">+</span> LangUtil<span style="color:#f92672">.</span><span style="color:#a6e22e">escapeString</span><span style="color:#f92672">(</span>firstName<span style="color:#f92672">)+</span><span style="color:#e6db74">&#34;\&#34;;&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;  last_name: \&#34;&#34;</span><span style="color:#f92672">+</span> LangUtil<span style="color:#f92672">.</span><span style="color:#a6e22e">escapeString</span><span style="color:#f92672">(</span>lastName<span style="color:#f92672">)+</span><span style="color:#e6db74">&#34;\&#34;;&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;} &#34;</span><span style="color:#f92672">+</span>exp<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  TweakFlow<span style="color:#f92672">.</span><span style="color:#a6e22e">evaluate</span><span style="color:#f92672">(</span>code<span style="color:#f92672">);</span> <span style="color:#75715e">// returns &#34;Dear Mary Poppins&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="examples">Examples</h3>
<p>See these <a href="https://github.com/twineworks/tweakflow/blob/master/src/test/java/com/twineworks/tweakflow/embedding/EvalExpressionInEmptyScopeTest.java">tests</a> for working examples of expression evaluation.</p>
<h2 id="evaluating-a-set-of-variables">Evaluating a set of variables</h2>
<p>If the application&rsquo;s use-case is to have users define a table of variables, then the <a href="https://github.com/twineworks/tweakflow/blob/master/src/main/java/com/twineworks/tweakflow/util/VarTable.java">VarTable</a> helper class supports implementing it efficiently. It creates an in-memory module with a library containing user variables, compiles to a runtime, and relates any compilation error to the offending variable. The application can provide a prologue with any imports and aliases it wants to be available in scope.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>VarTable table <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> VarTable<span style="color:#f92672">.</span><span style="color:#a6e22e">Builder</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">.</span><span style="color:#a6e22e">setPrologue</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// provided by the application
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#e6db74">&#34;alias customer.first_name as first_name;\n&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;alias customer.last_name as last_name;\n&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;library customer {\n&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;  provided first_name;\n&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;  provided last_name;\n&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// provided by the user
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">.</span><span style="color:#a6e22e">addVar</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;greeting&#34;</span><span style="color:#f92672">,</span> greetingExp<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">.</span><span style="color:#a6e22e">addVar</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;avatar&#34;</span><span style="color:#f92672">,</span> avatarExp<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">.</span><span style="color:#a6e22e">build</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Runtime runtime <span style="color:#f92672">=</span> table<span style="color:#f92672">.</span><span style="color:#a6e22e">compile</span><span style="color:#f92672">();</span>
</span></span></code></pre></div><h3 id="examples-1">Examples</h3>
<p>See the class <a href="https://github.com/twineworks/tweakflow/blob/master/src/test/java/com/twineworks/tweakflow/util/VarTableTest.java">test</a> for examples  demonstrating usage and error handling.</p>
<p>The <a href="https://github.com/twineworks/tweakflow/blob/master/src/main/java/com/twineworks/tweakflow/examples/LazilyProvidedVars.java">LazilyProvidedVars</a> sample compiles a var table and provides only variables that are actually referenced.</p>
<p>There is a <a href="https://github.com/twineworks/tweakflow/blob/master/src/main/java/com/twineworks/tweakflow/examples/VarTableEvaluation.java">demo application</a> which uses a var table. It asks the user for some expressions and verifies them.</p>
<p>You can run it using:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>java -cp tweakflow-1.4.4.jar com.twineworks.tweakflow.examples.VarTableEvaluation
</span></span></code></pre></div><p>An invocation might look like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Given a rectangle with sides of length a and b.
</span></span><span style="display:flex;"><span>What is the formula to calculate the circumference?
</span></span><span style="display:flex;"><span>circumference:
</span></span><span style="display:flex;"><span>2*a+2*b
</span></span><span style="display:flex;"><span>And the formula for calculating surface area?
</span></span><span style="display:flex;"><span>area: a*b
</span></span><span style="display:flex;"><span>Thanks. Checking answer...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Congratulations. The formulas seem to be correct.
</span></span></code></pre></div><h2 id="evaluating-modules">Evaluating modules</h2>
<p>If users need the standard library, or need the ability to define variables, libraries, or even modules themselves, then the application must generate and compile the set of modules involved.</p>
<p>The result is a <a href="https://github.com/twineworks/tweakflow/blob/master/src/main/java/com/twineworks/tweakflow/lang/runtime/Runtime.java">runtime</a> object that provides handles to all compiled modules, libraries, and variables. The application then supplies values for any variables it <a href="./reference.html#variables">provides</a>, and evaluates any variables it is interested in. The host application can determine which provided variables are actually referenced, so it can omit providing values that are not needed.</p>
<p>For the purposes of discussion, consider the following module.</p>
<pre tabindex="0"><code class="language-tweakflow" data-lang="tweakflow"># user_module.tf

import core, data, math, strings from &#39;std&#39;;

library customer {
  provided first_name;
  provided last_name;
}

library user {
  greeting: if customer.first_name &amp;&amp; customer.last_name
              &#34;Hello #{customer.first_name} #{customer.last_name}&#34;
            else
              &#34;Dear anonymous&#34;;
}
</code></pre><p>The steps to compile a set of modules are:</p>
<ul>
<li>Set up a load path so tweakflow knows where to look for imported modules.</li>
<li>Compile the modules. Any imports will be searched on the load path.</li>
</ul>
<p>A module might be a resource, a file, or an in-memory object. The load path contains <a href="https://github.com/twineworks/tweakflow/blob/master/src/main/java/com/twineworks/tweakflow/lang/load/loadpath/LoadPathLocation.java">LoadPathLocations</a> specifying where tweakflow will look for modules. Assuming user_module.tf was generated from user input and is just a string, the application must put it into a memory location, and place that location into the load path.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>MemoryLocation memLocation <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MemoryLocation<span style="color:#f92672">.</span><span style="color:#a6e22e">Builder</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;user_module.tf&#34;</span><span style="color:#f92672">,</span> moduleText<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span><span style="color:#a6e22e">build</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>LoadPath loadPath <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LoadPath<span style="color:#f92672">.</span><span style="color:#a6e22e">Builder</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">.</span><span style="color:#a6e22e">addStdLocation</span><span style="color:#f92672">()</span> <span style="color:#75715e">// ensure importing &#39;std&#39; imports the standard library
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>memLocation<span style="color:#f92672">)</span> <span style="color:#75715e">// memory location with &#34;user_module.tf&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">.</span><span style="color:#a6e22e">build</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Runtime runtime <span style="color:#f92672">=</span> TweakFlow<span style="color:#f92672">.</span><span style="color:#a6e22e">compile</span><span style="color:#f92672">(</span>loadPath<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;user_module.tf&#34;</span><span style="color:#f92672">);</span>
</span></span></code></pre></div><p>To interact with a compiled runtime:</p>
<ul>
<li>Supply values for any variables declared as <code>provided</code>.</li>
<li>Evaluate everything, or selectively just specific modules, libraries, or vars.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// get the module out of the runtime
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>Runtime<span style="color:#f92672">.</span><span style="color:#a6e22e">Module</span> module <span style="color:#f92672">=</span> runtime<span style="color:#f92672">.</span><span style="color:#a6e22e">getModules</span><span style="color:#f92672">().</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>runtime<span style="color:#f92672">.</span><span style="color:#a6e22e">unitKey</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;user_module.tf&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// set customer.first_name, and customer.last_name provided vars
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>Runtime<span style="color:#f92672">.</span><span style="color:#a6e22e">Var</span> firstName <span style="color:#f92672">=</span> module<span style="color:#f92672">.</span><span style="color:#a6e22e">getLibrary</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;customer&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">getVar</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;first_name&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>Runtime<span style="color:#f92672">.</span><span style="color:#a6e22e">Var</span> lastName <span style="color:#f92672">=</span> module<span style="color:#f92672">.</span><span style="color:#a6e22e">getLibrary</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;customer&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">getVar</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;last_name&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>firstName<span style="color:#f92672">.</span><span style="color:#a6e22e">update</span><span style="color:#f92672">(</span>Values<span style="color:#f92672">.</span><span style="color:#a6e22e">make</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Mary&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>lastName<span style="color:#f92672">.</span><span style="color:#a6e22e">update</span><span style="color:#f92672">(</span>Values<span style="color:#f92672">.</span><span style="color:#a6e22e">make</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Poppins&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// get a handle to user-supplied variable user.greeting
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>Runtime<span style="color:#f92672">.</span><span style="color:#a6e22e">Var</span> greeting <span style="color:#f92672">=</span> module<span style="color:#f92672">.</span><span style="color:#a6e22e">getLibrary</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;user&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">getVar</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;greeting&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// evaluate greeting
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>greeting<span style="color:#f92672">.</span><span style="color:#a6e22e">evaluate</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// retrieve whatever greeting evaluated to
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>Value userGreeting <span style="color:#f92672">=</span> greeting<span style="color:#f92672">.</span><span style="color:#a6e22e">getValue</span><span style="color:#f92672">();</span>
</span></span></code></pre></div><p>The application can continue updating provided variables and any dependent variables are re-evaluated automatically.</p>
<p>Every variable update triggers a re-evaluation of dependent variables. The runtime object has <code>updateVars</code> methods that atomically update multiple variables at once, which reduces unnecessary evaluation overhead, and avoids temporary inconsistencies.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Customer c <span style="color:#f92672">:</span> myCustomerCollection<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>  runtime<span style="color:#f92672">.</span><span style="color:#a6e22e">updateVars</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>    firstName<span style="color:#f92672">,</span> Values<span style="color:#f92672">.</span><span style="color:#a6e22e">make</span><span style="color:#f92672">(</span>c<span style="color:#f92672">.</span><span style="color:#a6e22e">getFirstName</span><span style="color:#f92672">()),</span>
</span></span><span style="display:flex;"><span>    lastName<span style="color:#f92672">,</span> Values<span style="color:#f92672">.</span><span style="color:#a6e22e">make</span><span style="color:#f92672">(</span>c<span style="color:#f92672">.</span><span style="color:#a6e22e">getLastName</span><span style="color:#f92672">())</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  String userGreeting <span style="color:#f92672">=</span> greeting<span style="color:#f92672">.</span><span style="color:#a6e22e">getValue</span><span style="color:#f92672">().</span><span style="color:#a6e22e">string</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="examples-2">Examples</h3>
<p>The <a href="https://github.com/twineworks/tweakflow/blob/master/src/main/java/com/twineworks/tweakflow/examples/ModuleEvaluation.java">ModuleEvaluation</a> sample compiles and calls into a set of modules.</p>
<p>The <a href="https://github.com/twineworks/tweakflow/blob/master/src/main/java/com/twineworks/tweakflow/examples/LazilyProvidedVars.java">LazilyProvidedVars</a> sample compiles a var table and provides only variables that are actually referenced by user-supplied expressions.</p>
<p>This <a href="https://github.com/twineworks/tweakflow/blob/master/src/test/java/com/twineworks/tweakflow/embedding/EvalProvidedVarsTest.java">unit test</a> demonstrates supplying values for provided variables.</p>
<h2 id="calling-user-functions">Calling user functions</h2>
<p>Users can provide tweakflow functions to the host application. The application can call them through the runtime using <code>call</code> on a runtime var object that evaluated to a function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// get a handle on time_format.format which evaluated to a function
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>Runtime<span style="color:#f92672">.</span><span style="color:#a6e22e">Var</span> format <span style="color:#f92672">=</span> module<span style="color:#f92672">.</span><span style="color:#a6e22e">getLibrary</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;time_format&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">getVar</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;format&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// get now() as per local timezone
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>Value now <span style="color:#f92672">=</span> Values<span style="color:#f92672">.</span><span style="color:#a6e22e">make</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> DateTimeValue<span style="color:#f92672">(</span>ZonedDateTime<span style="color:#f92672">.</span><span style="color:#a6e22e">now</span><span style="color:#f92672">()));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// result of calling format with now as argument
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>String formattedDate <span style="color:#f92672">=</span> format<span style="color:#f92672">.</span><span style="color:#a6e22e">call</span><span style="color:#f92672">(</span>now<span style="color:#f92672">).</span><span style="color:#a6e22e">string</span><span style="color:#f92672">();</span>
</span></span></code></pre></div><p>In case the application wants to call a function in a tight loop, it is more efficient to create a callsite first, which can cache some information involved in calling a function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// some constant overhead creating the callsite
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>Arity1CallSite callSite <span style="color:#f92672">=</span> format<span style="color:#f92672">.</span><span style="color:#a6e22e">arity1CallSite</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#f92672">;</span>i<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">1000</span><span style="color:#f92672">;</span>i<span style="color:#f92672">++){</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// less overhead per call when performing multiple calls
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;var callsite: &#34;</span><span style="color:#f92672">+</span>callSite<span style="color:#f92672">.</span><span style="color:#a6e22e">call</span><span style="color:#f92672">(</span>now<span style="color:#f92672">).</span><span style="color:#a6e22e">string</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>If the function value is not the current value of a variable, but has been obtained by the application in some other way, there is no var handle to relate the call back into the runtime. In these cases the application can obtain a call context from the runtime using <code>createCallContext</code> to call into any function value, regardless of its source.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Value f <span style="color:#f92672">=</span> getSomeFunctionValue<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// calling a function: variant 3, use runtime call context
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>CallContext callContext <span style="color:#f92672">=</span> runtime<span style="color:#f92672">.</span><span style="color:#a6e22e">createCallContext</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;runtime call context: &#34;</span><span style="color:#f92672">+</span> callContext<span style="color:#f92672">.</span><span style="color:#a6e22e">call</span><span style="color:#f92672">(</span>f<span style="color:#f92672">,</span> now<span style="color:#f92672">));</span>
</span></span></code></pre></div><h3 id="examples-3">Examples</h3>
<p>The <a href="https://github.com/twineworks/tweakflow/blob/master/src/main/java/com/twineworks/tweakflow/examples/CallingFunctions.java">CallingFunctions</a> sample contains demonstrations of all above techniques.</p>
<h2 id="error-handling">Error handling</h2>
<p>Tweakflow throws <a href="https://github.com/twineworks/tweakflow/blob/master/src/main/java/com/twineworks/tweakflow/lang/errors/LangException.java">LangExceptions</a> whenever something goes wrong.</p>
<p>There are three categories of errors that can happen: parse errors, compilation errors, and runtime errors. Parse errors indicate unrecognized syntax. Compilation errors occur when syntax is fine, but semantics are invalid. Referencing undefined variables, or defining variables more than once are common compilation errors. Runtime errors occur when tweakflow code throws errors during evaluation using the <a href="./reference.html#throwing-errors">throw</a> syntax.</p>
<p>An exception holds an <a href="https://github.com/twineworks/tweakflow/blob/master/src/main/java/com/twineworks/tweakflow/lang/errors/LangError.java">error code</a> and a message describing the error condition. You can get the value that was thrown by calling <code>toErrorValue</code>. Calling <code>getDigestMessage</code> returns a detailed error message that includes stack trace information. The exception usually contains a <a href="https://github.com/twineworks/tweakflow/blob/master/src/main/java/com/twineworks/tweakflow/lang/parse/SourceInfo.java">SourceInfo</a> object which gives the exact location of the error condition. Note however that source info may be <code>null</code>, in case the error happens in a context where no source information is available.</p>
<h3 id="examples-4">Examples</h3>
<p>See these <a href="https://github.com/twineworks/tweakflow/blob/master/src/test/java/com/twineworks/tweakflow/embedding">test files</a> for examples of handling errors. Each test file contains specific tests for error handling.</p>
<h2 id="limiting-evaluation-time">Limiting evaluation time</h2>
<p>The host application might wish to limit the evaluation time of user code. A good way to achieve this goal is to evaluate user code in a separate thread. The tweakflow interpreter reacts to thread interruption by throwing an exception.</p>
<p>The <a href="https://github.com/twineworks/tweakflow/blob/master/src/main/java/com/twineworks/tweakflow/examples/LimitingExecTime.java">LimitingExecTime</a> sample evaluates a set of expressions, each taking exponentially longer to evaluate than the next. Each expression is evaluated within an enforced time limit, so at some point the evaluations start timing out, and the application interrupts the evaluation thread.</p>

        
<footer>
  <div class="footer__copyright">
    © <a href="http://twineworks.com">Twineworks 2024</a>
  </div>
  <div class="footer__social"></div>
  <div class="footer__links">
    <a href="./legal_notice.html">Legal notice</a>
  </div>
</footer>

      </main>
    </div>

    

</body>

</html>
